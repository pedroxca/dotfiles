#!/bin/bash

descricao=$(cat <<'EOF'

Abre uma seleção de tipos de testes para rodar em um projeto Maven, buscando todos os arquivos *Test.java na pasta teste do projeto.

1. Rodar todos os testes
2. Escolher um teste específico
3. Escolher um teste e método
4. Rodar com Jacoco

Use a tag -r para rodar o teste comando anterior

EOF
)




source $HOME/.scripts/scripts-utils.sh

command_file="/tmp/last-command.txt"

save_last_command() {
  echo "$1" > $command_file
}

get_last_command() {
  if [[ ! -e $command_file ]]; then
    echo "Command file does not exist, run a command first!"
    abort
  fi
  cat $command_file
}

check_maven_project() {
  if [[ ! -e "pom.xml" ]]; then
 gum log --structured --level error "Não é um projeto maven"
  abort
fi
}


while getopts ":dr" opt; do
  case $opt in
    d)
      if [[ ! $descricao ]]; then
        echo "Descricao do comando não foi definida!"
        abort
      fi
      echo -e "$descricao" | gum format --theme=dark
      exit
      ;;
    r)
      check_maven_project
      comando=$(get_last_command)
      $comando
      exit
    ;;
  esac
done





check_maven_project



opcao=$(gum choose "1. Rodar todos os testes" "2. Escolher um teste" "3. Escolher um teste e método" "4. Rodar com Jacoco")
indexador="$(echo $opcao | cut -d '.' -f 1)"
opcao="$(echo $opcao | cut -d '.' -f 2)"


case $indexador in
  1)
    echo "Executando opção: $opcao..."

    comando="mvn test"
    save_last_command "$comando"
    echo "Executando: $comando"
    $comando
    ;;
  2)
    echo "Executando opção: $opcao..."

    tests="$(find -type f -name "*Test.java" -exec basename {} \;)"

    teste_escolhido="$(gum choose $tests)"

    if [[ $? -ne 0 ]]; then
      echo "Não foi escolhido um teste"
      abort
    fi

    comando="mvn test -Dtest=$teste_escolhido"
    save_last_command "$comando"
    echo "Executando: $comando"
    $comando

    ;;
  3)

    declare -A arquivos


    for dir in $(fd -H -t f -g '*Test.java'); do
      nome_arquivo=$(basename "$dir")
      arquivos["$nome_arquivo"]="$dir"
    done

    arquivo_selecionado=$(printf "%s\n" "${!arquivos[@]}" | gum choose)

    caminho_selecionado=${arquivos[$arquivo_selecionado]}


    metodos_string=""

    while IFS= read -r line; do
      if [[ "$line" == *"@Test"* ]]; then
        if IFS= read -r next_line; then
          if [[ $next_line =~ ([a-zA-Z_][a-zA-Z0-9_]*)[[:space:]]*\( ]]; then
            metodo="${BASH_REMATCH[1]}"
            metodos_string+=" $metodo"
          fi
        fi
      fi
    done < "$caminho_selecionado"
    IFS=" " metodos=( $metodos_string )
    metodo_escolhido=$(gum choose "${metodos[@]}")

    echo "Executando opção: $opcao..."



    comando="mvn test -Dtest=$teste_escolhido#$metodo_escolhido"

    save_last_command "$comando"
    echo "Executando: $comando"
    $comando


    ;;
  4)
    echo "Executando opção: $opcao..."


    comando="mvn verify"

    save_last_command "$comando"
    echo "Executando: $comando"
    $comando


    ;;

  *)
    gum log --structured --level error "Algo deu errado, abortando"
    abort

    ;;
esac


